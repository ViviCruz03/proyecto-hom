{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="gral-container">
    <h3>UNIDADES ECONÓMICAS ASIGNADAS</h3>
    <div class="table-responsive">
        <table class="table table-bordered" id="tablaSeguimiento">
            <thead class="table-primary">
                <tr>
                    <th>Nombre de la unidad económica</th>
                    <th>Estado</th>
                    <th>Municipio</th>
                    <th>Localidad</th>
                    <th>Latitud</th>
                    <th>Longitud</th>
                    <th>Fecha de actualización</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Aquí se agregarán dinámicamente las filas -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modal para editar el estado -->
<div class="modal fade" id="modalStatus" tabindex="-1" aria-labelledby="modalStatusLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalStatusLabel">Actualizar estado de la unidad económica</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formStatusUpdate">
                    <div class="mb-3">
                        <label for="estadoSelect" class="form-label">Estado de la unidad</label>
                        <select id="estadoSelect" class="form-select">
                            <option value="Prospecto">Prospecto</option>
                            <option value="Cliente Nuevo">Cliente Nuevo</option>
                            <option value="Ya era Cliente">Ya era Cliente</option>
                            <option value="Descartado">Descartado</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="fechaCambio" class="form-label">Fecha del cambio</label>
                        <input type="date" id="fechaCambio" class="form-control">
                    </div>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        obtenerUnidades();  // Cargar las unidades cuando la página se haya cargado
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function obtenerColorEstado(estado) {
        switch (estado) {
            case "Prospecto":
                return "#f7dc6f";
            case "Cliente Nuevo":
                return "#2ecc71";
            case "Ya era Cliente":
                return "#ebf5fb";
            case "Descartado":
                return "#909497";
            default:
                return "white";  
        }
    }

    function obtenerUnidades() {
        fetch('/obtener_unidades_por_asesor')
        .then(response => response.json())
        .then(data => {
            let tbody = document.querySelector("#tablaSeguimiento tbody");
            tbody.innerHTML = "";  // Limpiar la tabla
            
            if (data.unidades.length === 0) {
                tbody.innerHTML = "<tr><td colspan='3'>No hay unidades asignadas.</td></tr>";
            } else {
                data.unidades.forEach(unidad => {
                    let row = document.createElement('tr');
                    row.id = `unidad-${unidad.id}`;
                    row.style.backgroundColor = obtenerColorEstado(unidad.estado);

                    row.innerHTML = `
                        <td>${unidad.Nombre_de_la_Unidad_Economica}</td>
                        <td>${unidad.Entidad_federetiva}</td>
                        <td>${unidad.Municipio}</td>
                        <td>${unidad.Localidad}</td>
                        <td>${unidad.Latitud}</td>
                        <td>${unidad.Longitud}</td>
                        <td>${unidad.FechaEdicion}</td>
                        <td>${unidad.estado}</td>
                        <td><button class="btn btn-light" onclick="abrirModal(${unidad.id})">Editar</button></td>
                    `;

                    tbody.appendChild(row);
                });
            }
        })
        .catch(error => console.error("Error al obtener unidades:", error));
    }

    function abrirModal(unidadId) {
        const unidad = document.querySelector(`#unidad-${unidadId}`);
        const estado = unidad.querySelector("td:nth-child(2)").textContent;
        document.getElementById("estadoSelect").value = estado || "Prospecto";

        // Establecer la fecha actual por defecto
        const hoy = new Date().toISOString().split('T')[0];
        document.getElementById("fechaCambio").value = hoy;

        const form = document.getElementById("formStatusUpdate");
        form.onsubmit = function(e) {
            e.preventDefault();
            actualizarEstado(unidadId);
        };

        new bootstrap.Modal(document.getElementById('modalStatus')).show();
    }

    function actualizarEstado(unidadId) {
        const nuevoEstado = document.getElementById("estadoSelect").value;
        const fechaCambio = document.getElementById("fechaCambio").value; // Obtener la fecha seleccionada

        if (!fechaCambio) {
            alert("Por favor, selecciona una fecha.");
            return;
        }

        fetch('/actualizar_estado_unidad/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                id: unidadId,
                nuevo_estado: nuevoEstado,
                fecha_cambio: fechaCambio  // Enviar la fecha al backend
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const unidad = document.querySelector(`#unidad-${unidadId}`);
                unidad.querySelector("td:nth-child(8)").textContent = nuevoEstado;
                unidad.style.backgroundColor = obtenerColorEstado(nuevoEstado); // Actualizar color

                // Eliminar la fila después de actualizar
                unidad.remove(); // Esto elimina la fila de la tabla

                const myModal = bootstrap.Modal.getInstance(document.getElementById('modalStatus'));
                myModal.hide();
            } else {
                alert('Error al actualizar el estado');
            }
        })
        .catch(error => console.error("Error al actualizar el estado:", error));
    }
</script>

{% endblock %}
